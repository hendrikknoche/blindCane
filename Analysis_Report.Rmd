---
title: "Evaluating the detectionspace - statistical report"
author: "by Milo Marsfeldt Skovfoged, Alexander Schiller Rasmussen"
date: "18/5/2020"
output:
  word_document: default
  pdf_document: default
---

## Table of Contents
1. [Introduction](#introduction)
2. [Data information](#data-information)
3. [Predicition of course completion time](#predicition-of-course-completion-time)
4. [Collisions and Detections](#collisions-and-detections)

##Introduction (This doesent become a headline - why?)

This is the statistical report associated with the paper "Evaluating the detection space" by Milo Marsfeldt Skovfoged & Alexander Schiller rasmussen. The field of study lies in research on behalf of visually impaired/blind navigation through environments to find an ideal distance and Field of Detection (FOD) for the most progressive travel-route, while avoiding collisions as much as possible.
This report gives an overview of what data for the study was gathered and analysed, in regrads to different points of interrest.

```{r setup, include=FALSE,}
library(tidyverse)
library(readbulk)
library(lubridate)
library(ggplot2)
library(scales) 
library(magrittr)

#GetData
load('data_all.rda')

#Data Grouped by Snario
daggByScen <- df %>% filter(Person_Speed<3)%>%group_by(testID,day,Scenario,FOD,Range)%>%summarize(avgSpeed=mean(Person_Speed),medianSpeed=median(Person_Speed),maxSpeed=max(Person_Speed),minSpeed=min(Person_Speed),objectDetected=sum(objDet,na.rm = TRUE),objectCollisions=sum(objColl,na.rm = TRUE),Time=max(Time_in_MS*1000))%>% arrange(testID)

#add Coloum with sum of total time spent 
daggByScen$totalTimeTraining<-round(cumsum(daggByScen$Time))

#add Coloum with total time spent for a given FOD with a given Range
daggByScen <- daggByScen%>%group_by(FOD,day,Range)%>%mutate(timeFDRtrain=round(cumsum(Time)))

#add Coloum with total time spent for a given FOD
daggByScen <- daggByScen%>%group_by(FOD,day)%>%mutate(timeFDtrain=round(cumsum(Time)))

#add Coloum with total time spent for a given Day
daggByScen <- daggByScen%>%group_by(day)%>%mutate(timeDtrain=round(cumsum(Time)))
daggByCol <- df %>% filter(Person_Speed<3)%>%group_by(testID,day,Scenario,FOD,Range,objColl)%>%summarize(avgSpeed=mean(Person_Speed),medianSpeed=median(Person_Speed),maxSpeed=max(Person_Speed),minSpeed=min(Person_Speed),objectDetected=sum(objDet,na.rm = TRUE),objectCollisions=sum(objColl,na.rm = TRUE),Time=max(Time_in_MS*1000))%>% arrange(testID)


#Model equation
model_equation <- function(model, ...) {
  format_args <- list(...)
  
  model_coeff <- model$coefficients
  format_args$x <- abs(model$coefficients)
  model_coeff_sign <- sign(model_coeff)
  model_coeff_prefix <- case_when(model_coeff_sign == -1 ~ " - ",
                                  model_coeff_sign == 1 ~ " + ",
                                  model_coeff_sign == 0 ~ " + ")
  model_eqn <- paste(strsplit(as.character(model$call$formula), "~")[[2]], # 'y'
                     "=",
                     paste(if_else(model_coeff[1]<0, "- ", ""),
                           do.call(format, format_args)[1],
                           paste(model_coeff_prefix[-1],
                                 do.call(format, format_args)[-1],
                                 " * ",
                                 names(model_coeff[-1]),
                                 sep = "", collapse = ""),
                           sep = ""))
  return(model_eqn)
}


daggHeat <- df %>% filter(Person_Speed<3)%>%group_by(Scenario,FOD,Range,day)%>%summarize(avgSpeed=mean(Person_Speed),medianSpeed=median(Person_Speed),maxSpeed=max(Person_Speed),minSpeed=min(Person_Speed),objectDetected=sum(objDet,na.rm = TRUE),objectCollisions=sum(objColl,na.rm = TRUE),Time=max(Time_in_MS*1000))

###----------------Numeric Analysis part----------------###


dataWhole <- daggByScen %>%
  group_by(FOD, Range) %>%
  summarize(objectCollisions = mean(objectCollisions, na.rm = TRUE), objectDetected = mean(objectDetected, na.rm = TRUE), Time = mean(Time * 1000))

test<-daggByScen %>%
  group_by(FOD, Range) %>%
  summarize(objectCollisions = mean(objectCollisions, na.rm = TRUE), objectDetected = mean(objectDetected, na.rm = TRUE), Time = mean(Time * 1000))


#WOBBL removes the baseline from the data and leaves us with Whole-room and Corridor
daggByScenWOBL<-daggByScen[!daggByScen$FOD=="Baseline",]
m<-lm(Time~FOD*Range+totalTimeTraining,data=daggByScen[!daggByScen$FOD=="Baseline",])
summary(m)
model_equation(m)
daggByScenWOBL$predTime<-predict(m)

m0<-lm(log(Time)~log(totalTimeTraining)+FOD*log(Range),data=daggByScen)


baseDat <- daggByScen[daggByScen$FOD=="Baseline",]
mbaseDat <- lm(log(Time)~log(totalTimeTraining),data=baseDat)


wrDat <- daggByScen[daggByScen$FOD=="WholeRoom",]
mwrDat<- lm(log(Time)~log(totalTimeTraining),data=wrDat)


corrDat <- daggByScen[daggByScen$FOD=="Corridor",]
mcorrDat<- lm(log(Time)~log(totalTimeTraining),data=corrDat)

###----------------Plots data----------------###
lower_ci <- function(mean, se, n, conf_level = 0.95){
  lower_ci <- mean - qt(1 - ((1 - conf_level) / 2), n - 1) * se
}
upper_ci <- function(mean, se, n, conf_level = 0.95){
  upper_ci <- mean + qt(1 - ((1 - conf_level) / 2), n - 1) * se
}

daggByDFR<-daggByScen %>%group_by(FOD,day,Range)%>%summarize(totalTimeTraining=max(totalTimeTraining),avgTime=mean(Time),ssd = sd(Time),count=n(),se = ssd / sqrt(count))%>%mutate(lower_ci=lower_ci(avgTime,se,count),upper_ci=upper_ci(avgTime,se,count))

#Learning curve





knitr::opts_chunk$set(echo = TRUE)
```

## Data information
Below a summary of our data is presented. In total, a 420 tests were completed, using three different Field Of Detections (FOD), with WholeRoom and Corridor differing between three ranges (two, three and four meters). 
```{r first summary, echo=FALSE}

summary(daggByScen)
# summary(nameOfDataFile)
#Shows a table of the data (e.g. could be the coefficients for completion time to FOD compairson)
```


## Predicition of course completion time
Splitting the data up into different models for predection of completion time, the following coefficients were extracetd from each model.

Baseline data:
```{r baseData summary, echo=FALSE}
coef(lm(Time ~ totalTimeTraining, data = baseDat))
```

WholeRoom data
```{r wrData summary, echo=FALSE}
coef(lm(Time ~ totalTimeTraining, data = wrDat))
```

Corrdiro data
```{r corrData summary, echo=FALSE}
coef(lm(Time ~ totalTimeTraining, data = corrDat))
```



```{r Training time over scenario time, echo=FALSE, error=FALSE, fig.height=10, fig.width=10}
#Figure has an error
ggplot(daggByDFR,aes(x=totalTimeTraining,y=avgTime,color=factor(Range),shape=factor(Range)))+
  geom_point()+ 
  geom_smooth(size=0)+ 
  geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci))+
  stat_smooth(method = 'nls', formula = 'y~a*x^b', method.args = list(start= c(a = 1,b=1)),se=FALSE)+
  theme_bw()+
  facet_grid(cols=vars(FOD))
```


The heatmap shows the avg. speed per scenario for the different FODS with different ranges.
```{r, HmAvgspdScen, echo=FALSE, fig.height=10, fig.width=10}
ggplot(daggHeat, aes(x = Range, y = Scenario)) + 
  geom_tile(aes(fill = avgSpeed)) + 
  geom_text(aes(fill = daggHeat$avgSpeed, label = round(daggHeat$avgSpeed, 2))) + 
  scale_fill_gradient2(low = muted("red"), 
                       mid = "yellow", 
                       high = muted("green"), 
                       midpoint = 0.75) + 
  theme(panel.grid.major.x=element_blank(), 
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), 
        axis.text.x = element_text(angle=0, hjust = 1,vjust=1,size = 12,face = "bold"),
        plot.title = element_text(size=16,face="bold"),
        axis.text.y = element_text(size = 12,face = "bold")) + 
  ggtitle("HeatMap - avgSpeed per Scenario") + 
  theme(legend.title=element_text(face="bold", size=10)) + 
  scale_y_continuous(trans = "reverse")+
  labs(fill="avgSpeed") +
  facet_grid(cols=vars(FOD), row=vars(day))
```


## Collisions and Detections

The heatmap below shows object collisions for each scenario. Noteworthy that using WholeRoom DOF, the participant managed to achieve collisions on scenario one, day one, which is supposed to be a clear walkingpath with objects spread out to the sides.
```{r, HmColprScen, echo=FALSE, fig.height=10, fig.width=10}
ggplot(daggHeat, aes(x = Range, y = Scenario)) + 
  geom_tile(aes(fill = objectCollisions)) + 
  geom_text(aes(fill = daggHeat$objectCollisions, label = round(daggHeat$objectCollisions, 2))) + 
  scale_fill_gradient2(low = muted("green"), 
                       mid = "yellow", 
                       high = muted("red"), 
                       midpoint = 4) + 
  theme(panel.grid.major.x=element_blank(), 
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), 
        axis.text.x = element_text(angle=0, hjust = 1,vjust=1,size = 12,face = "bold"),
        plot.title = element_text(size=16,face="bold"),
        axis.text.y = element_text(size = 12,face = "bold")) + 
  ggtitle("HeatMap - Collisions per Scenario") + 
  theme(legend.title=element_text(face="bold", size=10)) + 
  scale_y_continuous(trans = "reverse")+
  labs(fill="Collisions") +
  facet_grid(cols=vars(FOD), row=vars(day))
```


The heatmap below shows object detections for each scenario. Again scenario one is very noteworthy of the few detections using Corridor FOD, where the walking path is clear, compared to Wholeroom FOD.
```{r, HmDetprScen, echo=FALSE, fig.height=10, fig.width=10}
ggplot(daggHeat, aes(x = Range, y = Scenario)) + 
  geom_tile(aes(fill = objectDetected)) + 
  geom_text(aes(fill = daggHeat$objectDetected, label = round(daggHeat$objectDetected, 2))) + 
  scale_fill_gradient2(low = muted("green"), 
                       mid = "yellow", 
                       high = muted("red"), 
                       midpoint = 30) + 
  theme(panel.grid.major.x=element_blank(), 
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), 
        axis.text.x = element_text(angle=0, hjust = 1,vjust=1,size = 12,face = "bold"),
        plot.title = element_text(size=16,face="bold"),
        axis.text.y = element_text(size = 12,face = "bold")) + 
  ggtitle("HeatMap - Detections per Scenario") + 
  theme(legend.title=element_text(face="bold", size=10)) + 
  scale_y_continuous(trans = "reverse")+
  labs(fill="Detections") +
  facet_grid(cols=vars(FOD), row=vars(day))
```

